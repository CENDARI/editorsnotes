{% extends 'emptylayout.html' %}

{% load staticfiles display sort jsondumps notzero todate %}

{% block css_nocompress %}
<link rel="stylesheet" href="{% static "bootstrap/css/bootstrap.min.css" %}">
<link rel="stylesheet" href="{% static "jquery-ui-1.8.18.custom/jquery-ui-1.8.18.custom.css" %}">
<link rel="stylesheet" href="{% static "cendari/css/facetview.css" %}">
<link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css' />
<style type="text/css">
  .container {
      height: 1%;
  }

  .hasDatepicker {
      width: 85px;
  }

  dd {
      font-size: small;
  }

  .leftpanel {
      float: left;
      padding: 5px;
      width: 200px;
      border: 1px solid black;
  }
  .mainpanel {
      padding: 5px;
      margin-left: 210px;
  }
  .highlighted {
    background: #faa732;
    padding: 2px;
  }
  .searchresult > a * {
    display: inline;
  }
  .searchresult {
    margin-bottom: .75em;
  }

.panel {
  font-size: 10pt;
  line-height: 15pt;
  padding: 5px 0px;
  margin: 5px 10px;
  border-top: 1px solid steelblue;
  display: inline-block;
  position: relative;
  text-align: left;
  font-family: corbel,verdana,sans-serif;
  min-width: 300px;
  min-height: 50px;
  width: 100%;
}

.panel .panelVis{
  display: inline-block;
}

.map{
  height:200px;
}

.map .mark .timeline{
  stroke: none;
  fillOpacity: 1;
  fill: true;
}

.leaflet-container {
    background: #fff;
}

.timeline{
  height: 75px;
}

.timeline > svg {
  font: 6px sans-serif;
}

.bar rect {
  fill: steelblue;
  shape-rendering: crispEdges;
}

.bg {
  fill: white;
}


.bar text {
  fill: #fff;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

rect.zoompane {
  cursor: move;
  fill: none;
  pointer-events: all;
}
</style>
{% endblock css_nocompress %}

{% block js_nocompress %}
<script src='//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js'></script>
<script type="text/javascript" src="{% static "function/jquery/jquery-1.8.2.min.js" %}"></script>
<script src='{% static 'function/d3/d3.v3.min.js' %}'></script>
<script type="text/javascript" src="{% static "bootstrap/js/bootstrap.js" %}"></script>
<script type="text/javascript" src="{% static "jquery-ui-1.8.18.custom/jquery-ui-1.8.18.custom.min.js" %}"></script>
<script type="text/javascript" src="{% static "cendari/js/latlon-geohash.js" %}"></script>
<script type="text/javascript" src="{% static "cendari/js/cendarisearch.js" %}"></script>


<script type="text/javascript">
{% autoescape off %}  
  function next_page(event) {
      event.preventDefault();
      var url = document.location.href;
      url = url.replace(/[&]from=[^&]*/, "");
      url = url + '&from='+Math.min({{sizes.total}}-{{sizes.size}}+1,{{sizes.from}}+{{sizes.size}});
      document.location.assign(url);
  }

  function prev_page(event) {
      event.preventDefault();
      var url = document.location.href;
      url = url.replace(/[&]from=[^&]*/, "");
      url = url + '&from='+Math.max(0,{{sizes.from}}-{{sizes.size}});
      document.location.assign(url);
  }
{% endautoescape %}
</script>

{% endblock js_nocompress %}

{% block nolayout_content %}
<form method="get" action=".">
  <p>
    <input type="text" name="q" value="{{ query }}">
    <input type="submit" value="Search">
  </p>

<!-- Begin faceting. -->
<div style="clear:both;" class="btn-toolbar" id="facetview_selectedfilters">
</div>
<div class="leftpanel facetpane">
  <h2>Facets (<a href="?q=">reset</a>)</h2>
  <hr>
  {% for facet, values in facets|sortiter %}
  <table id="facetview_{{facet}}" class="facetview_filters table table-bordered table-condensed table-striped" >
    <tr><td>
    {% if values %}
      {% if facet in selected_facets %}
     <a class="facetview_filtershow" title="filter by {{ facet}}" rel="{{facet }}" style="color:#999; font-weight:bold;" href=""><i class="icon-plus"></i> {{ facet|capfirst }} ({{ values.value_count }})</a>
      {% else %}
     <a class="facetview_filtershow" title="filter by {{ facet}}" rel="{{facet }}" style="color:#333; font-weight:bold;" href=""><i class="icon-plus"></i> {{ facet|capfirst }} ({{ values.value_count }})</a>
      {% endif %}
    {% else %}
     <a class="facetview_filtershow facetview_novalues" title="filter by {{ facet}}" rel="{{facet }}" style="color:#999; font-weight:bold;" href=""><i class="icon-plus"></i> {{ facet|capfirst }}</a>
    {% endif %}
    {% if facet == "location" %}
        <div class="btn-group facetview_locationfilteroptions" style="margin-top:5px;">
          <a class="btn btn-small facetview_learnmore" title="click to view search help information" href="#"><b>?</b></a> 
          <a class="btn btn-small facetview_filterlocation" title="filter location" rel="{{facet}}" href="filter_location">Filter</a>
          <a class="btn btn-small facetview_adaptresolution" title="adapt viewport" rel="{{facet}}" href="adapt_to_viewport">Adapt</a>
          <a class="btn btn-small facetview_resetlocation" title="reset location filter" href="no_location_filter">Reset</a>
	</div>
	<div class="panelVis map" style="min-height: 30px; min-width: 150px; width: 150px; position: relative;">
	</div>
	{% autoescape off %}
	<script>
    	  var map_data = {{values.buckets|json}}, 
	  map = d3.select('.map');
	  buildMap(map_data, map);
	</script>
	{% endautoescape %}
    </td></tr>
    {% elif facet == "date" %}
        <div class="btn-group facetview_datefilteroptions" style="margin-top:5px;">
          <a class="btn btn-small facetview_learnmore" title="click to view search help information" href="#"><b>?</b></a> 
          <a class="btn btn-small facetview_filterdate" title="filter date" rel="{{facet}}" href="filter_date">Filter</a>
          <a class="btn btn-small facetview_resetdate" title="reset date filter" href="no_location_filter">Reset</a>
	</div>
	<input type="text" id="min_date" name="min_date" value="{{values.bounds.0|todate}}">
	<input type="text" id="max_date" name="max_date" value="{{values.bounds.1|todate}}">
	<div class="panelVis timeline" style="min-height: 30px; min-width: 150px; width: 150px; position: relative;">
	</div>
	{% autoescape off %}
	<script>
    	  var date_data = {{values.buckets|json}}, 
	      timeline = d3.select('.timeline');
	  buildTimeline(date_data, timeline);
	  $(function() {
	      $( "#min_date" ).datepicker(datepicker_options);
	      $( "#max_date" ).datepicker(datepicker_options);
	  });
	</script>
	{% endautoescape %}
    </td></tr>
    {% else %}
        <div class="btn-group facetview_filteroptions" style="display:none; margin-top:5px;">
          <a class="btn btn-small facetview_learnmore" title="click to view search help information" href="#"><b>?</b></a> 
          <a class="btn btn-small facetview_morefacetvals" title="filter list size" rel="{{facet}}" href="show_facets={{facet}}:100">100</a>
          <a class="btn btn-small facetview_sort {{facet}}" title="filter value order" href="{{facet}}">Sort</a>
	</div>
    </td></tr>
    {% for value in values.buckets %}
    <tr class="facetview_filtervalue" style="display:none;">
      <td><a class="facetview_filterchoice facetview_toggle" rel="{{ facet }}" href="selected_facets={{ facet }}:{{ value.key }}">{{ value.key }} {{value.doc_count|notzero}}</a></td>
    </tr>
    {% endfor %}
    {% endif %}
  </table>
  {% endfor %}
</div>

<!-- End faceting -->

<div class="mainpanel">
  <h2>{{sizes.total}} Results
    {% if sizes.size < sizes.total %}
    ({{sizes.page}}/{{sizes.pages}})
    <a class="btn btn-small prev_page" title="Previous Page" href="prev">Prev</a>
    <a class="btn btn-small next_page" title="Next Page" href="prev">Next</a>
    {% endif %}
</h2>
  <dl>
    {% for document in results %}
    <dt><a href="{{ document.uri }}">{{ document.uri }}</a></dt>
    <dd>
{% autoescape off %}  
      {% for h in document.highlight %}
      {{ h }}<br>
      {% endfor %}
{% endautoescape %}
    </dd>
    {% endfor %}
  </ol>
{% if sizes.size < sizes.total %}
  <h2>
    <a class="btn btn-small prev_page" title="Previous Page" href="prev">Prev</a>
    <a class="btn btn-small next_page" title="Next Page" href="prev">Next</a>
  </h2>
{% endif %}
</div>

<script type="text/javascript">
    bind_faceted_widgets();
  $('.next_page').click(next_page);
  $('.prev_page').click(prev_page);
</script>
</form>
{% endblock nolayout_content %}
